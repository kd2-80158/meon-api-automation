name: CI - Run API tests & email report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    env:
      JAVA_VERSION: "11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"
          cache: maven

      - name: Create email.properties
        run: |
          mkdir -p config
          echo "smtp.host=${{ secrets.SMTP_HOST }}" > config/email.properties
          echo "smtp.port=${{ secrets.SMTP_PORT }}" >> config/email.properties
          echo "smtp.username=${{ secrets.SMTP_USERNAME }}" >> config/email.properties
          echo "smtp.password=${{ secrets.SMTP_PASSWORD }}" >> config/email.properties
          echo "smtp.from=${{ secrets.SMTP_FROM }}" >> config/email.properties
          echo "smtp.tls=${{ secrets.SMTP_TLS }}" >> config/email.properties
          echo "mail.recipients=${{ secrets.MAIL_RECIPIENTS }}" >> config/email.properties

      - name: Create config.json
        run: |
          mkdir -p config
          printf '%s' "${{ secrets.CONFIG_JSON }}" > config/config.json

      - name: Inject eSign document_data
        env:
          ESIGN_DOC_1: ${{ secrets.ESIGN_DOCUMENT_DATA_PART1 }}
          ESIGN_DOC_2: ${{ secrets.ESIGN_DOCUMENT_DATA_PART2 }}
          ESIGN_DOC_3: ${{ secrets.ESIGN_DOCUMENT_DATA_PART3 }}
        run: |
          python3 <<'EOF'
          import json, os

          with open('config/config.json', 'r') as f:
              data = json.load(f)

          if 'baseURL' not in data or 'eSign' not in data['baseURL']:
              raise RuntimeError('Invalid config.json structure')

          data['baseURL']['eSign']['document_data'] = (
              os.environ['ESIGN_DOC_1'] +
              os.environ['ESIGN_DOC_2'] +
              os.environ['ESIGN_DOC_3']
          )

          with open('config/config.json', 'w') as f:
              json.dump(data, f, ensure_ascii=False)

          print(
              'document_data injected, length =',
              len(data['baseURL']['eSign']['document_data'])
          )
          EOF

      - name: Validate config.json
        run: |
          python3 <<'EOF'
          import json
          d = json.load(open('config/config.json'))
          assert 'document_data' in d['baseURL']['eSign']
          assert len(d['baseURL']['eSign']['document_data']) > 1000
          print('config validation OK')
          EOF

      - name: Ensure logs directory
        run: mkdir -p logs

      - name: Build & Run Tests
        run: mvn -B -DskipTests=false test

      - name: Verify logs and reports
        run: |
          ls -la logs || true
          [ -f logs/report.html ] && echo "report.html OK" || echo "report.html missing"
          [ -f logs/automation.log ] && echo "automation.log OK" || echo "automation.log missing"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
            logs/report.html
            logs/automation.log
            target/surefire-reports/**

      - name: Push report to dashboard
        if: always()
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git fetch origin
          git checkout gh-pages || git checkout -b gh-pages
          mkdir -p dashboard/data dashboard/reports dashboard/logs
          cp logs/report.html dashboard/reports/ || true
          cp logs/automation.log dashboard/logs/ || true
          echo '{ "summary": "latest run" }' > dashboard/data/latest.json
          git add dashboard/
          git commit -m "Update dashboard [skip ci]" || true
          git push origin gh-pages

      - name: Send Email With Test Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Test Report — ${{ github.repository }} — ${{ github.ref_name }}"
          body: |
            <p>Hi team,</p>
            <p>Automated API Tests completed.</p>
          content_type: text/html
          to: ${{ secrets.MAIL_RECIPIENTS }}
          from: ${{ secrets.SMTP_FROM }}
          attachments: logs/report.html,logs/automation.log
