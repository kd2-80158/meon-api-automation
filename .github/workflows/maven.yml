name: CI - Run API tests & email report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: "11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      ##################################################################
      # CREATE email.properties FROM GITHUB SECRETS
      ##################################################################
      - name: Create config/email.properties
        run: |
          mkdir -p config
          echo "smtp.host=${{ secrets.SMTP_HOST }}" > config/email.properties
          echo "smtp.port=${{ secrets.SMTP_PORT }}" >> config/email.properties
          echo "smtp.username=${{ secrets.SMTP_USERNAME }}" >> config/email.properties
          echo "smtp.password=${{ secrets.SMTP_PASSWORD }}" >> config/email.properties
          echo "smtp.from=${{ secrets.SMTP_FROM }}" >> config/email.properties
          echo "smtp.tls=${{ secrets.SMTP_TLS }}" >> config/email.properties
          echo "mail.recipients=${{ secrets.MAIL_RECIPIENTS }}" >> config/email.properties

      ##################################################################
      # INJECT COMPANY_NAME + SECRET_TOKEN INTO config.json
      ##################################################################
      - name: Inject secrets into config.json
        run: |
          sed -i "s|\${COMPANY_NAME}|${{ secrets.COMPANY_NAME }}|g" config/config.json
          sed -i "s|\${SECRET_TOKEN}|${{ secrets.SECRET_TOKEN }}|g" config/config.json

      ##################################################################
      # CREATE logs directory
      ##################################################################
      - name: Ensure logs dir exists
        run: mkdir -p logs

      ##################################################################
      # RUN MAVEN TESTS
      ##################################################################
      - name: Build & Run Tests
        run: mvn -B -DskipTests=false test

      ##################################################################
      # CHECK FILES
      ##################################################################
      - name: Verify logs and reports
        run: |
          echo "Contents of logs/"
          ls -la logs || true

          echo "Checking report.html"
          [ -f logs/report.html ] && echo "Report OK" || echo "Missing report.html"

          echo "Checking automation.log"
          [ -f logs/automation.log ] && echo "Log OK" || echo "Missing automation.log"

      ##################################################################
      # UPLOAD ARTIFACT (OPTIONAL)
      ##################################################################
      - name: Upload test report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
            logs/report.html
            logs/automation.log
            target/surefire-reports/**

      - name: Push report to dashboard
        if: always()    # <-- even if tests failed
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # Clone the repo using the GitHub token
          git fetch origin
          
          # Checkout gh-pages or create it if missing
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout -b gh-pages
          fi

          mkdir -p dashboard/data dashboard/reports dashboard/logs

          # Copy CI outputs into dashboard
          cp logs/report.html dashboard/reports/ || true
          cp logs/automation.log dashboard/logs/ || true

          # If you generate summary JSON, else create dummy
          if [ -f target/surefire-reports/summary.json ]; then
            cp target/surefire-reports/summary.json dashboard/data/latest.json
          else
            echo '{ "summary": "no summary generated" }' > dashboard/data/latest.json
          fi

          # Commit & push without triggering CI again
          git add dashboard/
          git commit -m "Update dashboard [skip ci]" || true
          git push origin gh-pages



      ##################################################################
      # SEND EMAIL WITH REPORT & LOG FILE
      ##################################################################
      - name: Send Email With Test Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Test Report — ${{ github.repository }} — ${{ github.ref_name }}"
          body: |
            <p>Hi team,</p>
            <p>Automated API Tests completed for <b>${{ github.repository }}</b>.</p>
            <p>Attached: logs/report.html and logs/automation.log</p>
          content_type: text/html
          to: ${{ secrets.MAIL_RECIPIENTS }}
          from: ${{ secrets.SMTP_FROM }}
          attachments: logs/report.html,logs/automation.log
