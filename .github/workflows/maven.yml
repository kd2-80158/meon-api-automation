name: CI - Run API tests & email report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-${{ secrets.JAVA_VERSION }}-openjdk-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ secrets.JAVA_VERSION }}

      - name: Build & run tests
        run: |
          # ensure logs dir exists
          mkdir -p logs
          # run maven tests
          mvn -B -DskipTests=false test

      - name: Ensure report and log exist
        run: |
          echo "Listing logs folder:"
          ls -la logs || true
          # Fail if report missing? we'll continue but record artifacts
          if [ ! -f logs/report.html ]; then
            echo "WARNING: logs/report.html missing"
          fi
          if [ ! -f logs/automation.log ]; then
            echo "WARNING: logs/automation.log missing"
          fi

      - name: Upload report artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
            logs/report.html
            logs/automation.log

      - name: Send email with report and automation log
        uses: dawidd6/action-send-mail@v3
        with:
          # from/to
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Test report — ${{ github.repository }} — ${{ github.ref_name }}"
          body: |
            Hi team,

            Tests finished for repo: ${{ github.repository }} on ${{ github.ref_name }}.

            Summary attached: logs/report.html and logs/automation.log
          content_type: text/html
          to: ${{ secrets.MAIL_RECIPIENTS }}
          from: ${{ secrets.SMTP_FROM }}
          # attach files (they must exist in the workspace)
          attachments: logs/report.html,logs/automation.log
