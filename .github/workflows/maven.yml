name: CI - Run API tests & email report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    env:
      JAVA_VERSION: "11"

    steps:
      ############################################################
      # CHECKOUT CODE
      ############################################################
      - name: Checkout
        uses: actions/checkout@v4

      ############################################################
      # SETUP JAVA
      ############################################################
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      ############################################################
      # CREATE email.properties FROM SECRETS
      ############################################################
      - name: Create email.properties
        run: |
          mkdir -p config
          echo "smtp.host=${{ secrets.SMTP_HOST }}" > config/email.properties
          echo "smtp.port=${{ secrets.SMTP_PORT }}" >> config/email.properties
          echo "smtp.username=${{ secrets.SMTP_USERNAME }}" >> config/email.properties
          echo "smtp.password=${{ secrets.SMTP_PASSWORD }}" >> config/email.properties
          echo "smtp.from=${{ secrets.SMTP_FROM }}" >> config/email.properties
          echo "smtp.tls=${{ secrets.SMTP_TLS }}" >> config/email.properties
          echo "mail.recipients=${{ secrets.MAIL_RECIPIENTS }}" >> config/email.properties

      ############################################################
      # CREATE config.json FROM CONFIG_JSON SECRET
      ############################################################
      - name: Create config.json
        run: |
          mkdir -p config
          echo '${{ secrets.CONFIG_JSON }}' > config/config.json

      ############################################################
      # INJECT ESIGN document_data (3 BASE64 CHUNKS)
      ############################################################
      - name: Inject eSign document_data
        env:
          ESIGN_DOC_1: ${{ secrets.ESIGN_DOCUMENT_DATA_BASE64_1 }}
          ESIGN_DOC_2: ${{ secrets.ESIGN_DOCUMENT_DATA_BASE64_2 }}
          ESIGN_DOC_3: ${{ secrets.ESIGN_DOCUMENT_DATA_BASE64_3 }}
        run: |
          python3 -c "
import json, os

with open('config/config.json') as f:
    data = json.load(f)

document_data = (
    os.environ['ESIGN_DOC_1']
  + os.environ['ESIGN_DOC_2']
  + os.environ['ESIGN_DOC_3']
)

data['baseURL']['eSign']['document_data'] = document_data

with open('config/config.json', 'w') as f:
    json.dump(data, f)

print('document_data injected, length:', len(document_data))
"

      ############################################################
      # VALIDATE CONFIG (FAIL FAST)
      ############################################################
      - name: Validate config.json
        run: |
          python3 -c "
import json
with open('config/config.json') as f:
    d = json.load(f)

assert 'baseURL' in d
assert 'eSign' in d['baseURL']
assert 'document_data' in d['baseURL']['eSign']
assert len(d['baseURL']['eSign']['document_data']) > 1000
print('config.json validation OK')
"

      ############################################################
      # CREATE LOGS DIRECTORY
      ############################################################
      - name: Ensure logs directory
        run: mkdir -p logs

      ############################################################
      # RUN MAVEN TESTS
      ############################################################
      - name: Build & Run Tests
        run: mvn -B -DskipTests=false test

      ############################################################
      # VERIFY LOGS & REPORTS
      ############################################################
      - name: Verify logs and reports
        run: |
          echo "Logs directory:."
          ls -la logs || true

          echo "Checking report.html."
          [ -f logs/report.html ] && echo "report.html OK" || echo "report.html missing"

          echo "Checking automation.log."
          [ -f logs/automation.log ] && echo "automation.log OK" || echo "automation.log missing"

      ############################################################
      # UPLOAD ARTIFACTS
      ############################################################
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
            logs/report.html
            logs/automation.log
            target/surefire-reports/**

      ############################################################
      # PUSH REPORT TO gh-pages DASHBOARD
      ############################################################
      - name: Push report to dashboard
        if: always()
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git fetch origin

          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout -b gh-pages
          fi

          mkdir -p dashboard/data dashboard/reports dashboard/logs

          cp logs/report.html dashboard/reports/ || true
          cp logs/automation.log dashboard/logs/ || true

          if [ -f target/surefire-reports/summary.json ]; then
            cp target/surefire-reports/summary.json dashboard/data/latest.json
          else
            echo '{ "summary": "no summary generated" }' > dashboard/data/latest.json
          fi

          git add dashboard/
          git commit -m "Update dashboard [skip ci]" || true
          git push origin gh-pages

      ############################################################
      # SEND EMAIL WITH REPORT
      ############################################################
      - name: Send Email With Test Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Test Report — ${{ github.repository }} — ${{ github.ref_name }}"
          body: |
            <p>Hi team,</p>
            <p>Automated API Tests completed for <b>${{ github.repository }}</b>.</p>
            <p>Attached: logs/report.html and logs/automation.log</p>
          content_type: text/html
          to: ${{ secrets.MAIL_RECIPIENTS }}
          from: ${{ secrets.SMTP_FROM }}
          attachments: logs/report.html,logs/automation.log
